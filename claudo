#!/bin/bash

show_help() {
    cat << 'EOF'
claudo - Run Claude Code in a Docker container

Usage: claudo [OPTIONS] [--] [COMMAND...]

Options:
  -e KEY=VALUE    Set environment variable in container (can be used multiple times)
  -p, --prompt PROMPT  Run claude with -p (prompt mode)
  -i, --image IMG Use specified Docker image (default: $CLAUDO_IMAGE or built-in)
  --host          Use host network mode
  --no-sudo       Disable sudo (adds no-new-privileges restriction)
  --no-privileges Drop all capabilities (most restrictive)
  --no-network    Disable network access (breaks Claude Code)
  --dind          Docker-in-Docker (runs dockerd inside container, requires privileged)
  --docker-socket Mount host Docker socket (sibling containers, host root equivalent)
  --git           Mount git config (~/.gitconfig and credentials) for committing
  --pull          Always pull the latest image before running
  -n, --name NAME Create a named container 'claudo-NAME' that persists after exit
  -a, --attach NAME  Attach to existing container 'claudo-NAME'
  --tmp           Run isolated (no directory mount, workdir /workspaces/tmp)
  -v, --verbose   Display docker command before executing
  --dry-run       Show docker command without executing (implies --verbose)
  --docker-opts OPTS  Pass additional options to docker run
  -h, --help      Show this help message

Arguments after -- are passed directly as the container command.

Examples:
  claudo                          Run claude --dangerously-skip-permissions (default)
  claudo -e API_KEY=xxx           Start with environment variable
  claudo -i claudo-base:latest    Use a different image
  claudo --host                   Start with host networking
  claudo --no-sudo                Start without sudo privileges
  claudo --no-privileges          Start with all caps dropped
  claudo --no-network             Start without network access
  claudo --dind                   Docker-in-Docker (isolated daemon)
  claudo --docker-socket          Use host Docker socket (sibling containers)
  claudo --git                    Enable git commits from inside container
  claudo -n myproject             Start named persistent container
  claudo -a myproject             Attach to existing container
  claudo -- claude --help         Run claude with arguments
  claudo -n dev -e DEBUG=1 -- claude
                                  Combined options with command

The current directory is mounted at /workspaces/<dirname>.
~/.claude is mounted for authentication persistence.
EOF
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    show_help
    exit 0
fi

current_dir=$(pwd)
dir_name=$(basename "$current_dir")
# Sanitize directory name for Docker volume mount (colons break -v syntax)
safe_dir_name="${dir_name//:/-}"

env_args=()
network_args=()
prompt_arg=""
container_name=""
attach_name=""
remove_flag="--rm"
image="${CLAUDO_IMAGE:-ghcr.io/gregmuellegger/claudo:latest}"
command_args=()
tmp_mode=false
no_sudo=false
no_privileges=false
no_network=false
git_mode=false
dind_mode=false
docker_socket_mode=false
pull_mode=false
verbose=false
dry_run=false
docker_opts=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -e)
            env_args+=("-e" "$2")
            shift 2
            ;;
        -p|--prompt)
            prompt_arg="$2"
            shift 2
            ;;
        -i|--image)
            image="$2"
            shift 2
            ;;
        --host)
            network_args=("--network" "host")
            shift
            ;;
        --no-sudo)
            no_sudo=true
            shift
            ;;
        --no-privileges)
            no_privileges=true
            shift
            ;;
        --no-network)
            no_network=true
            shift
            ;;
        --dind)
            dind_mode=true
            shift
            ;;
        --docker-socket)
            docker_socket_mode=true
            shift
            ;;
        --pull)
            pull_mode=true
            shift
            ;;
        --git)
            git_mode=true
            shift
            ;;
        -n|--name)
            container_name="$2"
            remove_flag=""
            shift 2
            ;;
        -a|--attach)
            attach_name="$2"
            shift 2
            ;;
        --tmp)
            tmp_mode=true
            shift
            ;;
        -v|--verbose)
            verbose=true
            shift
            ;;
        --dry-run)
            dry_run=true
            verbose=true
            shift
            ;;
        --docker-opts)
            docker_opts="$2"
            shift 2
            ;;
        --)
            shift
            command_args=("$@")
            break
            ;;
        *)
            command_args+=("$1")
            shift
            ;;
    esac
done

# Validate: --attach doesn't support command override
if [[ -n "$attach_name" && ${#command_args[@]} -gt 0 ]]; then
    echo "Error: --attach cannot override the container command" >&2
    echo "Use 'docker exec -it claudo-$attach_name ${command_args[*]}' to run a different command" >&2
    exit 1
fi

# Use -it if stdin is a terminal, otherwise just -i for piped input
if [[ -t 0 ]]; then
    tty_flag="-it"
else
    tty_flag="-i"
fi

docker_args=(
    run $tty_flag $remove_flag
    --hostname claudo
    -v "$HOME/.claude:/home/claudo/.claude"
)

# Security: --no-sudo adds no-new-privileges restriction
if [[ "$no_sudo" == true ]]; then
    docker_args+=(--security-opt=no-new-privileges:true)
fi

# No privileges mode: drop all capabilities
if [[ "$no_privileges" == true ]]; then
    docker_args+=(--cap-drop=ALL)
fi

# No network mode: disable all network access
if [[ "$no_network" == true ]]; then
    docker_args+=(--network=none)
fi

# Pull mode: always pull latest image
if [[ "$pull_mode" == true ]]; then
    docker_args+=(--pull=always)
fi

# Git mode: mount git configuration files
if [[ "$git_mode" == true ]]; then
    if [[ -f "$HOME/.gitconfig" ]]; then
        docker_args+=(-v "$HOME/.gitconfig:/home/claudo/.gitconfig:ro")
    fi
    if [[ -f "$HOME/.git-credentials" ]]; then
        docker_args+=(-v "$HOME/.git-credentials:/home/claudo/.git-credentials:ro")
    fi
fi

# Docker socket mode: mount host docker socket (siblings mode)
if [[ "$docker_socket_mode" == true ]]; then
    docker_args+=(-v "/var/run/docker.sock:/var/run/docker.sock")
fi

# Docker-in-Docker: run dockerd inside container
if [[ "$dind_mode" == true ]]; then
    docker_args+=(--privileged)
    docker_args+=(-e "DIND_ENABLED=true")
    docker_args+=(-v "claudo-dind-storage:/var/lib/docker")
fi

if [[ "$tmp_mode" == true ]]; then
    docker_args+=(-w "/workspaces/tmp")
else
    # Validate source path doesn't contain colons (breaks Docker -v syntax)
    if [[ "$current_dir" == *:* ]]; then
        echo "Error: Directory path contains ':' which breaks Docker volume mounts" >&2
        echo "Path: $current_dir" >&2
        echo "Use --tmp mode or rename the directory" >&2
        exit 1
    fi
    docker_args+=(-v "$current_dir:/workspaces/$safe_dir_name")
    docker_args+=(-w "/workspaces/$safe_dir_name")
fi

if [[ -n "$container_name" ]]; then
    docker_args+=("--name" "claudo-$container_name")
fi

docker_args+=("${env_args[@]}")
docker_args+=("${network_args[@]}")
# shellcheck disable=SC2086
[[ -n "$docker_opts" ]] && docker_args+=($docker_opts)
docker_args+=("$image")

if [[ -n "$prompt_arg" ]]; then
    # Prompt mode: run claude -p with the provided prompt
    docker_args+=("claude" "--dangerously-skip-permissions" "-p" "$prompt_arg")
elif [[ ${#command_args[@]} -eq 0 ]]; then
    if [[ -t 0 ]]; then
        docker_args+=("claude" "--dangerously-skip-permissions")
    else
        # Piped input with no command - send to claude -p
        docker_args+=("claude" "--dangerously-skip-permissions" "-p")
    fi
else
    docker_args+=("${command_args[@]}")
fi

if [[ "$verbose" == true ]]; then
    printf '\e[2mdocker %s\e[0m\n' "${docker_args[*]}" >&2
fi

if [[ "$dry_run" == true ]]; then
    exit 0
fi

# Handle attach mode
if [[ -n "$attach_name" ]]; then
    full_name="claudo-$attach_name"

    # Check if container exists
    if ! docker ps -a --format '{{.Names}}' | grep -q "^${full_name}$"; then
        echo "Error: Container '$full_name' does not exist" >&2
        echo "Use 'claudo -n $attach_name' to create it first" >&2
        exit 1
    fi

    # Build the start command
    start_args=(start -ai "$full_name")

    if [[ "$verbose" == true ]]; then
        printf '\e[2mdocker %s\e[0m\n' "${start_args[*]}" >&2
    fi

    docker "${start_args[@]}"
    exit $?
fi

docker "${docker_args[@]}"
